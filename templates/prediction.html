<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Chest Cancer Diagnosis</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --bg-light: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg-dark: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 100%);
      --text-light: #1a202c;  /* Dark text for light mode */
      --text-dark: #f0f0f0;   /* Light text for dark mode */
      --card-bg-light: rgba(255, 255, 255, 0.95);
      --card-bg-dark: rgba(30, 30, 30, 0.95);
      --accent-color: #2d5a27;  /* Darker green */
      --secondary-color: #1565c0;  /* Darker blue */
      --tertiary-color: #e65100;   /* Darker orange */
      --success-color: #2e7d32;
      --info-color: #1976d2;
      --warning-color: #f57c00;
      --danger-color: #d32f2f;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--bg-light);
      font-family: 'Inter', sans-serif;
      color: var(--text-light);
      transition: all 0.3s ease;
      scroll-behavior: smooth;
      min-height: 100vh;
      position: relative;
    }

    body.dark {
      background: var(--bg-dark);
      color: var(--text-dark);
    }

    /* Animated background particles */
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }

    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
      50% { transform: translateY(-20px) rotate(180deg); opacity: 0.8; }
    }

    .dark-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      border: none;
      border-radius: 50px;
      padding: 12px 20px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      color: white;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .dark-toggle:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 80px 20px;
    }

    .page-header {
      text-align: center;
      margin-bottom: 60px;
      opacity: 0;
      transform: translateY(30px);
      animation: slideUp 1s ease-out 0.3s forwards;
    }

    @keyframes slideUp {
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .main-title {
      font-size: 3.5rem;
      font-weight: 700;
      margin-bottom: 20px;
      background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.2;
    }

    .subtitle {
      font-size: 1.3rem;
      opacity: 0.9;
      color: white;
      font-weight: 300;
      margin-bottom: 30px;
    }

    body.dark .subtitle {
      color: var(--text-dark);
    }

    section {
      opacity: 0;
      transform: translateY(30px);
      animation: slideUp 1s ease-out 0.6s forwards;
    }

    .card {
      background: var(--card-bg-light);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 30px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.4);
    }

    body.dark .card {
      background: var(--card-bg-dark);
      color: var(--text-dark);
    }

    .upload-area {
      border: 3px dashed #ddd;
      border-radius: 16px;
      padding: 40px 20px;
      text-align: center;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      min-height: 350px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .upload-area.dragover {
      border-color: var(--accent-color);
      background: rgba(46, 125, 50, 0.1);
      transform: scale(1.02);
    }

    .upload-area.has-image {
      border-color: var(--accent-color);
      background: rgba(46, 125, 50, 0.05);
    }

    .image-preview {
      max-width: 100%;
      max-height: 300px;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      display: none;
    }

    .upload-placeholder {
      color: #666;
      font-size: 1.1rem;
    }

    body.dark .upload-placeholder {
      color: #ccc;
    }

    .upload-icon {
      font-size: 4rem;
      color: var(--accent-color);
      margin-bottom: 20px;
      opacity: 0.7;
    }

    .btn-custom {
      padding: 12px 25px;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 50px;
      border: none;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      margin: 5px;
      min-width: 120px;
      justify-content: center;
    }

    .btn-custom::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-custom:hover::before {
      left: 100%;
    }

    .btn-upload {
      background: linear-gradient(135deg, var(--info-color), #0d47a1);
      color: white;
      box-shadow: 0 8px 25px rgba(25, 118, 210, 0.4);
    }

    .btn-upload:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(25, 118, 210, 0.6);
      color: white;
    }

    .btn-predict {
      background: linear-gradient(135deg, var(--success-color), #1b5e20);
      color: white;
      box-shadow: 0 8px 25px rgba(46, 125, 50, 0.4);
    }

    .btn-predict:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(46, 125, 50, 0.6);
      color: white;
    }

    .btn-predict:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-train {
      background: linear-gradient(135deg, var(--warning-color), #e65100);
      color: white;
      box-shadow: 0 8px 25px rgba(245, 124, 0, 0.4);
    }

    .btn-train:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(245, 124, 0, 0.6);
      color: white;
    }

    .btn-download {
      background: transparent;
      color: var(--text-light);
      border: 2px solid var(--text-light);
      font-size: 0.9rem;
      padding: 8px 16px;
    }

    .btn-download:hover {
      background: var(--text-light);
      color: white;
      transform: translateY(-2px);
    }

    body.dark .btn-download {
      color: var(--text-dark);
      border-color: var(--text-dark);
    }

    body.dark .btn-download:hover {
      background: var(--text-dark);
      color: var(--text-light);
    }

    .results-card {
      min-height: 400px;
    }

    .result-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--accent-color);
      text-align: center;
    }

    .prediction-result {
      background: rgba(46, 125, 50, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid var(--success-color);
    }

    .prediction-result.normal {
      background: rgba(46, 125, 50, 0.1);
      border-left-color: var(--success-color);
    }

    .prediction-result.cancer {
      background: rgba(211, 47, 47, 0.1);
      border-left-color: var(--danger-color);
    }

    .predicted-class {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--success-color);
      margin-bottom: 10px;
    }

    .predicted-class.cancer {
      color: var(--danger-color);
    }

    .confidence-table {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      overflow: hidden;
      margin-top: 20px;
    }

    .confidence-table th {
      background: var(--accent-color);
      color: white;
      font-weight: 600;
      padding: 15px;
      text-align: center;
      border: none;
    }

    .confidence-table td {
      padding: 12px 15px;
      text-align: center;
      border: none;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .confidence-bar {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 5px;
    }

    .confidence-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success-color), var(--accent-color));
      border-radius: 4px;
      transition: width 0.8s ease;
    }

    /* Medical Guidance Sections */
    .medical-guidance {
      margin-top: 30px;
      padding: 25px;
      border-radius: 16px;
      border-left: 4px solid;
    }

    .medical-guidance.normal {
      background: rgba(46, 125, 50, 0.1);
      border-left-color: var(--success-color);
    }

    .medical-guidance.cancer {
      background: rgba(211, 47, 47, 0.1);
      border-left-color: var(--danger-color);
    }

    .guidance-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .guidance-title.normal {
      color: var(--success-color);
    }

    .guidance-title.cancer {
      color: var(--danger-color);
    }

    .guidance-content {
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .treatment-section {
      background: rgba(25, 118, 210, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      border-left: 4px solid var(--info-color);
    }

    .treatment-title {
      color: var(--info-color);
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .medication-list {
      list-style: none;
      padding: 0;
    }

    .medication-list li {
      background: rgba(255, 255, 255, 0.1);
      margin: 8px 0;
      padding: 12px 15px;
      border-radius: 8px;
      border-left: 3px solid var(--info-color);
    }

    .medication-name {
      font-weight: 600;
      color: var(--info-color);
    }

    .helpline-section {
      background: rgba(245, 124, 0, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      border-left: 4px solid var(--warning-color);
    }

    .helpline-title {
      color: var(--warning-color);
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .helpline-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }

    .helpline-number {
      font-weight: 600;
      color: var(--warning-color);
    }

    .resource-links {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .resource-link {
      display: block;
      padding: 15px;
      background: rgba(25, 118, 210, 0.1);
      border-radius: 8px;
      border-left: 3px solid var(--info-color);
      text-decoration: none;
      color: inherit;
      transition: all 0.3s ease;
    }

    .resource-link:hover {
      background: rgba(25, 118, 210, 0.2);
      transform: translateX(5px);
      text-decoration: none;
      color: inherit;
    }

    .resource-link-title {
      font-weight: 600;
      color: var(--info-color);
      margin-bottom: 5px;
    }

    .resource-link-desc {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .info-section {
      background: var(--card-bg-light);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 30px;
      margin-top: 40px;
      position: relative;
      overflow: hidden;
      opacity: 0;
      transform: translateY(30px);
      animation: slideUp 1s ease-out 0.9s forwards;
    }

    .info-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--info-color), var(--tertiary-color));
    }

    body.dark .info-section {
      background: var(--card-bg-dark);
      color: var(--text-dark);
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .info-item {
      background: rgba(25, 118, 210, 0.1);
      border-radius: 12px;
      padding: 20px;
      border-left: 4px solid var(--info-color);
    }

    .info-item h5 {
      color: var(--info-color);
      margin-bottom: 10px;
      font-weight: 600;
    }

    .info-item p {
      margin: 0;
      line-height: 1.6;
      font-size: 0.95rem;
    }

    .navigation-section {
      text-align: center;
      margin-top: 40px;
      opacity: 0;
      transform: translateY(30px);
      animation: slideUp 1s ease-out 1.2s forwards;
    }

    .btn-nav {
      background: transparent;
      color: white;
      border: 2px solid white;
      padding: 12px 25px;
      margin: 0 10px;
    }

    .btn-nav:hover {
      background: white;
      color: var(--text-light);
      transform: translateY(-2px);
      text-decoration: none;
    }

    body.dark .btn-nav {
      color: var(--text-dark);
      border-color: var(--text-dark);
    }

    body.dark .btn-nav:hover {
      background: var(--text-dark);
      color: var(--text-light);
    }

    /* Loading overlay */
    #loading {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      display: none;
      align-items: center;
      justify-content: center;
    }

    .loader {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid var(--accent-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      color: white;
      margin-top: 20px;
      font-size: 1.1rem;
      text-align: center;
    }

    @media (max-width: 768px) {
      .main-title {
        font-size: 2.5rem;
      }
      
      .container {
        padding: 40px 20px;
      }
      
      .card {
        padding: 20px;
      }
      
      .upload-area {
        min-height: 250px;
        padding: 20px;
      }
      
      .btn-custom {
        width: 100%;
        margin: 5px 0;
      }
      
      .info-grid, .resource-links {
        grid-template-columns: 1fr;
      }
    }

    /* Success and error states */
    .success-state {
      border-color: var(--success-color) !important;
      background: rgba(46, 125, 50, 0.1) !important;
    }

    .error-state {
      border-color: var(--danger-color) !important;
      background: rgba(211, 47, 47, 0.1) !important;
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <!-- Animated Background Particles -->
  <div class="particles" id="particles"></div>

  <!-- Theme Toggle -->
  <button class="btn dark-toggle" id="toggleTheme">
    <i class="fas fa-moon"></i>
  </button>

  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <h1 class="main-title">
        <i class="fas fa-microscope" style="color: #e74c3c;"></i>
        AI Chest Cancer Diagnosis
      </h1>
      <p class="subtitle">
        Advanced Deep Learning Model for Chest X-Ray Analysis and Cancer Classification
      </p>
    </div>

    <section>
      <div class="row">
        <!-- Upload Section -->
        <div class="col-lg-6 mb-4">
          <div class="card">
            <h4 class="text-center mb-4" style="color: var(--accent-color);">
              <i class="fas fa-upload"></i> Upload Chest X-Ray
            </h4>
            
            <div class="upload-area" id="uploadArea">
              <div class="upload-content">
                <div class="upload-icon">
                  <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-placeholder">
                  <strong>Click to upload</strong> or drag and drop your chest X-ray image
                  <br><small>Supported formats: JPG, PNG, JPEG (Max 10MB)</small>
                </div>
                <img id="photo" class="image-preview" alt="Uploaded X-ray" />
                <video autoplay id="video" style="display: none;"></video>
                <canvas id="canvas" style="display:none;"></canvas>
              </div>
            </div>

            <div class="text-center mt-4">
              <form id="upload-form">
                <input name="upload" type="file" id="fileinput" accept="image/*" style="display: none;" />
                <button type="button" class="btn-custom btn-upload" id="uload">
                  <i class="fas fa-folder-open"></i> Choose File
                </button>
                <button type="button" class="btn-custom btn-predict" id="send" disabled>
                  <i class="fas fa-brain"></i> Analyze Image
                </button>
                <button type="button" class="btn-custom btn-train" id="trainbtn">
                  <i class="fas fa-cogs"></i> Retrain Model
                </button>
                <input type="hidden" id="url" value="/predict" />
              </form>
            </div>
          </div>
        </div>

        <!-- Results Section -->
        <div class="col-lg-6 mb-4">
          <div class="card results-card">
            <h4 class="result-title">
              <i class="fas fa-chart-bar"></i> Diagnosis Results
            </h4>
            
            <div class="jsonRes">
              <div class="text-center" style="padding: 60px 20px; color: #666;">
                <i class="fas fa-stethoscope" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;"></i>
                <p>Upload a chest X-ray image to get AI-powered diagnosis results</p>
                <small>Our model can detect: Adenocarcinoma, Large Cell Carcinoma, Normal, Squamous Cell Carcinoma</small>
              </div>
            </div>
            
            <div class="text-center download-btns" style="display: none;">
              <button class="btn-custom btn-download" id="downloadPDF">
                <i class="fas fa-file-pdf"></i> Download PDF
              </button>
              <button class="btn-custom btn-download ml-2" id="downloadCSV">
                <i class="fas fa-file-csv"></i> Download CSV
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Information Section -->
    <div class="info-section">
      <h3 style="color: var(--info-color); text-align: center; margin-bottom: 30px;">
        <i class="fas fa-info-circle"></i> How Our AI Diagnosis Works
      </h3>
      
      <div class="info-grid">
        <div class="info-item">
          <h5><i class="fas fa-upload"></i> Image Upload</h5>
          <p>Upload high-quality chest X-ray images in JPEG or PNG format. Our system accepts images up to 10MB in size.</p>
        </div>
        
        <div class="info-item">
          <h5><i class="fas fa-brain"></i> AI Analysis</h5>
          <p>Our deep learning model, trained on thousands of medical images, analyzes the X-ray for signs of different cancer types.</p>
        </div>
        
        <div class="info-item">
          <h5><i class="fas fa-chart-pie"></i> Classification</h5>
          <p>The AI provides confidence scores for four categories: Adenocarcinoma, Large Cell Carcinoma, Normal, and Squamous Cell Carcinoma.</p>
        </div>
        
        <div class="info-item">
          <h5><i class="fas fa-download"></i> Results Export</h5>
          <p>Download your diagnosis results in PDF or CSV format for medical records or further consultation with healthcare professionals.</p>
        </div>
      </div>
      
      <div style="background: rgba(211, 47, 47, 0.1); border-radius: 12px; padding: 20px; margin-top: 30px; border-left: 4px solid var(--danger-color);">
        <h5 style="color: var(--danger-color); margin-bottom: 10px;">
          <i class="fas fa-exclamation-triangle"></i> Important Medical Disclaimer
        </h5>
        <p style="margin: 0; font-size: 0.95rem;">
          This AI tool is for educational and research purposes only. It should not be used as a substitute for professional medical diagnosis, treatment, or advice. Always consult with qualified healthcare professionals for medical decisions.
        </p>
      </div>
    </div>

    <!-- Navigation Section -->
    <div class="navigation-section">
      <a href="/" class="btn-custom btn-nav">
        <i class="fas fa-home"></i> Back to Home
      </a>
      <a href="/importance" class="btn-custom btn-nav">
        <i class="fas fa-info-circle"></i> Learn More
      </a>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loading">
    <div style="text-align: center;">
      <div class="loader"></div>
      <div class="loading-text">
        <div id="loadingMessage">Analyzing your X-ray image...</div>
        <small>This may take a few moments</small>
      </div>
    </div>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    let base_data = "";
    let lastPrediction = null;

    // Medical guidance data
    const medicalGuidance = {
      'Normal': {
        type: 'normal',
        title: 'Great News! Your X-ray Appears Normal',
        icon: 'fas fa-check-circle',
        message: `Congratulations! The AI analysis suggests that your chest X-ray appears normal with no signs of cancer detected. This is excellent news for your health.`,
        recommendations: [
          'Continue maintaining a healthy lifestyle with regular exercise and balanced nutrition',
          'Avoid smoking and limit exposure to secondhand smoke',
          'Schedule regular health check-ups as recommended by your healthcare provider',
          'Consider annual chest X-rays if you have risk factors (smoking history, family history, occupational exposure)',
          'Maintain good respiratory hygiene and avoid prolonged exposure to pollutants'
        ],
        nextSteps: [
          'Share these results with your primary care physician during your next visit',
          'Discuss your risk factors and prevention strategies with your doctor',
          'Continue following recommended screening schedules based on your age and risk profile',
          'Seek immediate medical attention if you develop concerning symptoms like persistent cough, chest pain, or shortness of breath'
        ]
      },
      'Adenocarcinoma': {
        type: 'cancer',
        title: 'Adenocarcinoma Detected - Immediate Medical Attention Required',
        icon: 'fas fa-exclamation-triangle',
        message: `The AI analysis suggests the presence of adenocarcinoma, a type of lung cancer. This requires immediate medical evaluation and treatment planning.`,
        urgentActions: [
          'Contact your healthcare provider immediately to discuss these results',
          'Request an urgent referral to an oncologist or pulmonologist',
          'Schedule additional diagnostic tests (CT scan, PET scan, biopsy) as recommended',
          'Gather your complete medical history and current medications list',
          'Consider seeking a second opinion from a cancer specialist'
        ],
        treatments: [
          {
            name: 'Targeted Therapy',
            description: 'Drugs like Erlotinib (Tarceva), Gefitinib (Iressa), or Osimertinib (Tagrisso) for specific genetic mutations',
            note: 'Requires genetic testing to determine eligibility'
          },
          {
            name: 'Immunotherapy',
            description: 'Pembrolizumab (Keytruda), Nivolumab (Opdivo), or Atezolizumab (Tecentriq)',
            note: 'Effectiveness depends on PD-L1 expression levels'
          },
          {
            name: 'Chemotherapy',
            description: 'Combination therapies like Carboplatin + Paclitaxel or Cisplatin + Pemetrexed',
            note: 'Often used in combination with other treatments'
          },
          {
            name: 'Surgical Options',
            description: 'Lobectomy, segmentectomy, or pneumonectomy depending on tumor location and stage',
            note: 'Best outcomes when cancer is detected early'
          }
        ]
      },
      'Large Cell Carcinoma': {
        type: 'cancer',
        title: 'Large Cell Carcinoma Detected - Urgent Medical Care Needed',
        icon: 'fas fa-exclamation-triangle',
        message: `The AI analysis indicates possible large cell carcinoma, an aggressive form of lung cancer. Immediate medical intervention is crucial.`,
        urgentActions: [
          'Seek emergency medical consultation within 24-48 hours',
          'Request immediate referral to a thoracic oncologist',
          'Schedule comprehensive staging workup (CT, PET, brain MRI)',
          'Prepare for potential hospitalization for rapid treatment initiation',
          'Contact cancer support services for emotional and practical support'
        ],
        treatments: [
          {
            name: 'Aggressive Chemotherapy',
            description: 'Platinum-based combinations like Cisplatin + Etoposide or Carboplatin + Paclitaxel',
            note: 'Often requires multiple cycles with close monitoring'
          },
          {
            name: 'Radiation Therapy',
            description: 'External beam radiation therapy, often combined with chemotherapy',
            note: 'May be used for symptom control or curative intent'
          },
          {
            name: 'Surgical Resection',
            description: 'Lobectomy or bilobectomy if cancer is localized and patient is surgical candidate',
            note: 'Best option for early-stage disease'
          },
          {
            name: 'Immunotherapy',
            description: 'Checkpoint inhibitors like Pembrolizumab or Nivolumab for advanced stages',
            note: 'May be combined with chemotherapy for better outcomes'
          }
        ]
      },
      'Squamous Cell Carcinoma': {
        type: 'cancer',
        title: 'Squamous Cell Carcinoma Detected - Immediate Medical Evaluation Required',
        icon: 'fas fa-exclamation-triangle',
        message: `The AI analysis suggests squamous cell carcinoma of the lung. This type of cancer requires prompt medical attention and treatment planning.`,
        urgentActions: [
          'Contact your doctor immediately to schedule an urgent appointment',
          'Request referral to a pulmonary oncologist or thoracic surgeon',
          'Arrange for comprehensive staging studies (CT chest/abdomen/pelvis, PET scan)',
          'Prepare for bronchoscopy with biopsy for tissue confirmation',
          'Consider enrollment in clinical trials for advanced treatment options'
        ],
        treatments: [
          {
            name: 'Platinum-Based Chemotherapy',
            description: 'Cisplatin + Gemcitabine, Carboplatin + Paclitaxel, or Cisplatin + Vinorelbine',
            note: 'Standard first-line treatment for advanced disease'
          },
          {
            name: 'Immunotherapy',
            description: 'Pembrolizumab (Keytruda), Nivolumab (Opdivo), or combination immunotherapy',
            note: 'Particularly effective for squamous cell type'
          },
          {
            name: 'Surgical Treatment',
            description: 'Lobectomy, sleeve resection, or pneumonectomy based on tumor location',
            note: 'Preferred treatment for early-stage disease'
          },
          {
            name: 'Radiation Therapy',
            description: 'Stereotactic body radiation therapy (SBRT) or conventional radiation',
            note: 'Used alone or in combination with other treatments'
          }
        ]
      }
    };

    // Helpline numbers and resources
    const helplineNumbers = [
      { name: 'National Cancer Helpline', number: '1-800-4-CANCER (1-800-422-6237)', available: '24/7' },
      { name: 'American Cancer Society', number: '1-800-227-2345', available: '24/7' },
      { name: 'CancerCare Helpline', number: '1-800-813-4673', available: 'Mon-Fri 9AM-5PM EST' },
      { name: 'Lung Cancer Alliance', number: '1-800-298-2436', available: 'Mon-Fri 9AM-5PM EST' },
      { name: 'National Suicide Prevention Lifeline', number: '988', available: '24/7' }
    ];

    const medicalResources = [
      {
        title: 'National Cancer Institute',
        url: 'https://www.cancer.gov/types/lung',
        description: 'Comprehensive information about lung cancer types, treatments, and clinical trials'
      },
      {
        title: 'American Cancer Society',
        url: 'https://www.cancer.org/cancer/lung-cancer.html',
        description: 'Patient resources, support groups, and treatment information'
      },
      {
        title: 'Lung Cancer Alliance',
        url: 'https://www.lungcanceralliance.org/',
        description: 'Patient advocacy, support services, and educational resources'
      },
      {
        title: 'CancerCare',
        url: 'https://www.cancercare.org/cancertype/lung_cancer',
        description: 'Free professional support services and financial assistance'
      },
      {
        title: 'Clinical Trials Database',
        url: 'https://clinicaltrials.gov/',
        description: 'Search for clinical trials and experimental treatments'
      },
      {
        title: 'National Comprehensive Cancer Network',
        url: 'https://www.nccn.org/patients/guidelines/content/PDF/lung-patient.pdf',
        description: 'Evidence-based treatment guidelines for patients'
      }
    ];

    // Create animated particles
    function createParticles() {
      const particlesContainer = document.getElementById('particles');
      const particleCount = 50;

      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.top = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 6 + 's';
        particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
        particlesContainer.appendChild(particle);
      }
    }

    function generateMedicalGuidance(predictedClass) {
      const guidance = medicalGuidance[predictedClass];
      if (!guidance) return '';

      let html = `
        <div class="medical-guidance ${guidance.type}">
          <div class="guidance-title ${guidance.type}">
            <i class="${guidance.icon}"></i>
            ${guidance.title}
          </div>
          <div class="guidance-content">
            <p><strong>${guidance.message}</strong></p>
          </div>`;

      // Add urgent actions for cancer types
      if (guidance.urgentActions) {
        html += `
          <div class="treatment-section">
            <div class="treatment-title">
              <i class="fas fa-exclamation-circle"></i>
              Immediate Actions Required
            </div>
            <ul class="medication-list">`;
        guidance.urgentActions.forEach(action => {
          html += `<li><strong>•</strong> ${action}</li>`;
        });
        html += `</ul></div>`;
      }

      // Add recommendations for normal results
      if (guidance.recommendations) {
        html += `
          <div class="treatment-section">
            <div class="treatment-title">
              <i class="fas fa-heart"></i>
              Health Maintenance Recommendations
            </div>
            <ul class="medication-list">`;
        guidance.recommendations.forEach(rec => {
          html += `<li><strong>•</strong> ${rec}</li>`;
        });
        html += `</ul></div>`;
      }

      // Add treatment options for cancer types
      if (guidance.treatments) {
        html += `
          <div class="treatment-section">
            <div class="treatment-title">
              <i class="fas fa-pills"></i>
              Potential Treatment Options
            </div>
            <ul class="medication-list">`;
        guidance.treatments.forEach(treatment => {
          html += `
            <li>
              <div class="medication-name">${treatment.name}</div>
              <div>${treatment.description}</div>
              <small style="opacity: 0.8; font-style: italic;">${treatment.note}</small>
            </li>`;
        });
        html += `</ul></div>`;
      }

      // Add next steps for normal results
      if (guidance.nextSteps) {
        html += `
          <div class="treatment-section">
            <div class="treatment-title">
              <i class="fas fa-clipboard-list"></i>
              Next Steps & Follow-up
            </div>
            <ul class="medication-list">`;
        guidance.nextSteps.forEach(step => {
          html += `<li><strong>•</strong> ${step}</li>`;
        });
        html += `</ul></div>`;
      }

      // Add helpline numbers
      html += `
        <div class="helpline-section">
          <div class="helpline-title">
            <i class="fas fa-phone"></i>
            Emergency Helplines & Support
          </div>`;
      helplineNumbers.forEach(helpline => {
        html += `
          <div class="helpline-item">
            <i class="fas fa-phone-alt"></i>
            <div>
              <div class="helpline-number">${helpline.name}: ${helpline.number}</div>
              <small>Available: ${helpline.available}</small>
            </div>
          </div>`;
      });
      html += `</div>`;

      // Add medical resources
      html += `
        <div class="treatment-section">
          <div class="treatment-title">
            <i class="fas fa-globe"></i>
            Medical Resources & Support
          </div>
          <div class="resource-links">`;
      medicalResources.forEach(resource => {
        html += `
          <a href="${resource.url}" target="_blank" class="resource-link">
            <div class="resource-link-title">${resource.title}</div>
            <div class="resource-link-desc">${resource.description}</div>
          </a>`;
      });
      html += `</div></div>`;

      html += `</div>`;
      return html;
    }

    function sendRequest(base64Data) {
      if (!base64Data) {
        alert("Please upload an image first!");
        return;
      }
      
      $("#loading").css('display', 'flex');
      $("#loadingMessage").text("Analyzing your X-ray image...");

      $.ajax({
        url: $("#url").val(),
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ image: base64Data }),
        success: function(res) {
          lastPrediction = res;
          displayResults(res);
          $("#loading").hide();
          $(".download-btns").show();
        },
        error: function(xhr, status, error) {
          console.error("Prediction error:", error);
          $(".jsonRes").html(`
            <div class="text-center" style="padding: 40px 20px;">
              <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--danger-color); margin-bottom: 20px;"></i>
              <h5 style="color: var(--danger-color);">Prediction Failed</h5>
              <p>There was an error analyzing your image. Please try again with a different image.</p>
            </div>
          `);
          $("#loading").hide();
        }
      });
    }

    function displayResults(res) {
      const isCancer = res.predicted_class !== 'Normal';
      const resultClass = isCancer ? 'cancer' : 'normal';
      
      let html = `
        <div class="prediction-result ${resultClass}">
          <div class="predicted-class ${resultClass}">
            <i class="fas fa-diagnoses"></i> Predicted Diagnosis: ${res.predicted_class}
          </div>
          <small style="opacity: 0.8;">Based on AI analysis of the uploaded chest X-ray</small>
        </div>
        
        <h6 style="margin-bottom: 15px; color: var(--accent-color);">
          <i class="fas fa-chart-bar"></i> Confidence Scores
        </h6>
        <table class="table confidence-table">
          <thead>
            <tr>
              <th>Condition</th>
              <th>Confidence</th>
              <th>Probability</th>
            </tr>
          </thead>
          <tbody>`;
      
      // Sort by confidence score
      const sortedScores = Object.entries(res.confidence_scores)
        .sort(([,a], [,b]) => b - a);
      
      sortedScores.forEach(([key, value]) => {
        const percentage = (value * 100).toFixed(2);
        const isHighest = value === Math.max(...Object.values(res.confidence_scores));
        html += `
          <tr ${isHighest ? 'style="background: rgba(46, 125, 50, 0.1);"' : ''}>
            <td style="font-weight: ${isHighest ? '600' : '400'};">
              ${isHighest ? '<i class="fas fa-star" style="color: var(--success-color); margin-right: 5px;"></i>' : ''}
              ${key}
            </td>
            <td>
              <div class="confidence-bar">
                <div class="confidence-fill" style="width: ${percentage}%;"></div>
              </div>
            </td>
            <td style="font-weight: ${isHighest ? '600' : '400'}; color: ${isHighest ? 'var(--success-color)' : 'inherit'};">
              ${percentage}%
            </td>
          </tr>`;
      });
      
      html += `</tbody></table>`;

      // Add medical guidance
      html += generateMedicalGuidance(res.predicted_class);
      
      html += `
        <div style="background: rgba(25, 118, 210, 0.1); border-radius: 8px; padding: 15px; margin-top: 20px; border-left: 4px solid var(--info-color);">
          <small style="display: block; margin-bottom: 5px; font-weight: 600; color: var(--info-color);">
            <i class="fas fa-lightbulb"></i> Important Reminder:
          </small>
          <small style="line-height: 1.5;">
            This AI analysis is a screening tool only. ${isCancer ? 'Immediate medical consultation is essential for proper diagnosis and treatment planning.' : 'Regular medical check-ups remain important for maintaining good health.'}
          </small>
        </div>`;
      
      $(".jsonRes").html(html);
      
      // Add success state to upload area
      $("#uploadArea").addClass(isCancer ? "error-state" : "success-state");
    }

    $(document).ready(function() {
      // Initialize particles
      createParticles();

      // Theme toggle
      $('#toggleTheme').click(function() {
        $('body').toggleClass('dark');
        const isDark = $('body').hasClass('dark');
        $(this).html(isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
      });

      // Load saved theme
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        $('body').addClass('dark');
        $('#toggleTheme').html('<i class="fas fa-sun"></i>');
      }

      // Upload button click
      $("#uload").click(() => $('#fileinput').click());

      // Drag and drop functionality
      const uploadArea = document.getElementById('uploadArea');
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
      });

      uploadArea.addEventListener('drop', handleDrop, false);

      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
      }

      // File input change
      $("#fileinput").change(function() {
        if (this.files && this.files[0]) {
          handleFile(this.files[0]);
        }
      });

      function handleFile(file) {
        if (!file.type.startsWith('image/')) {
          alert('Please upload an image file (JPG, PNG, JPEG)');
          return;
        }

        if (file.size > 10 * 1024 * 1024) {
          alert('File size must be less than 10MB');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          const url = e.target.result;
          const img = new Image();
          img.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.height = img.height;
            canvas.width = img.width;
            ctx.drawImage(img, 0, 0);
            base_data = canvas.toDataURL('image/jpeg', 1.0).replace(/^data:image.+;base64,/, '');
          };
          img.src = url;
          
          $('#photo').attr('src', url).show();
          $('#video').hide();
          $('.upload-placeholder').hide();
          $('.upload-icon').hide();
          $('#uploadArea').addClass('has-image');
          $('#send').prop('disabled', false).removeClass('pulse');
          
          // Add pulse effect to predict button
          setTimeout(() => $('#send').addClass('pulse'), 500);
        };
        reader.readAsDataURL(file);
      }

      // Predict button click
      $('#send').click(() => {
        $('#send').removeClass('pulse');
        sendRequest(base_data);
      });

      // Train button click
      $('#trainbtn').click(() => {
        $("#loading").css('display', 'flex');
        $("#loadingMessage").text("Retraining the AI model...");
        
        $.ajax({
          url: "/train",
          type: "GET",
          success: function(response) {
            alert("Model training completed successfully!");
            $("#loading").hide();
          },
          error: function() {
            alert("Training failed! Please try again later.");
            $("#loading").hide();
          }
        });
      });

      // Download PDF
      $('#downloadPDF').click(() => {
        if (!lastPrediction) {
          alert("No prediction results to download.");
          return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Header
        doc.setFontSize(20);
        doc.setTextColor(45, 90, 39);
        doc.text("AI Chest Cancer Diagnosis Report", 20, 30);
        
        // Date
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 45);
        
        // Predicted class
        doc.setFontSize(16);
        doc.setTextColor(45, 90, 39);
        doc.text(`Predicted Diagnosis: ${lastPrediction.predicted_class}`, 20, 65);
        
        // Confidence scores
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        doc.text("Confidence Scores:", 20, 85);
        
        let y = 100;
        Object.entries(lastPrediction.confidence_scores)
          .sort(([,a], [,b]) => b - a)
          .forEach(([key, value]) => {
            doc.setFontSize(12);
            doc.text(`${key}: ${(value * 100).toFixed(2)}%`, 25, y);
            y += 15;
          });
        
        // Medical guidance summary
        const guidance = medicalGuidance[lastPrediction.predicted_class];
        if (guidance) {
          y += 20;
          doc.setFontSize(14);
          doc.setTextColor(25, 118, 210);
          doc.text("Medical Guidance:", 20, y);
          y += 15;
          
          doc.setFontSize(10);
          doc.setTextColor(0, 0, 0);
          const message = doc.splitTextToSize(guidance.message, 170);
          doc.text(message, 20, y);
          y += message.length * 5 + 10;
          
          // Add helpline numbers
          doc.setFontSize(12);
          doc.setTextColor(245, 124, 0);
          doc.text("Emergency Helplines:", 20, y);
          y += 10;
          
          doc.setFontSize(10);
          doc.setTextColor(0, 0, 0);
          helplineNumbers.slice(0, 3).forEach(helpline => {
            doc.text(`${helpline.name}: ${helpline.number}`, 25, y);
            y += 8;
          });
        }
        
        // Disclaimer
        y += 20;
        doc.setFontSize(10);
        doc.setTextColor(211, 47, 47);
        doc.text("MEDICAL DISCLAIMER:", 20, y);
        y += 10;
        doc.setTextColor(0, 0, 0);
        const disclaimer = "This AI tool is for educational purposes only. Always consult healthcare professionals for medical decisions.";
        const splitDisclaimer = doc.splitTextToSize(disclaimer, 170);
        doc.text(splitDisclaimer, 20, y);
        
        doc.save("chest_cancer_diagnosis_report.pdf");
      });

      // Download CSV
      $('#downloadCSV').click(() => {
        if (!lastPrediction) {
          alert("No prediction results to download.");
          return;
        }
        
        let csv = `Condition,Confidence Score (%),Timestamp\n`;
        const timestamp = new Date().toISOString();
        
        Object.entries(lastPrediction.confidence_scores)
          .sort(([,a], [,b]) => b - a)
          .forEach(([key, value]) => {
            csv += `${key},${(value * 100).toFixed(2)},${timestamp}\n`;
          });
        
        csv += `\nPredicted Diagnosis,${lastPrediction.predicted_class},${timestamp}\n`;
        
        // Add medical guidance summary
        const guidance = medicalGuidance[lastPrediction.predicted_class];
        if (guidance) {
          csv += `\nMedical Guidance,"${guidance.message.replace(/"/g, '""')}",${timestamp}\n`;
          
          // Add helpline numbers
          csv += `\nHelpline Numbers:\n`;
          helplineNumbers.forEach(helpline => {
            csv += `"${helpline.name}","${helpline.number}","${helpline.available}"\n`;
          });
        }
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'chest_cancer_diagnosis_results.csv';
        a.click();
        URL.revokeObjectURL(url);
      });

      // Click upload area to trigger file input
      $('#uploadArea').click(function() {
        if (!$(this).hasClass('has-image')) {
          $('#fileinput').click();
        }
      });
    });
  </script>
</body>
</html>